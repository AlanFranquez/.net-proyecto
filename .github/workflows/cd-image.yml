name: CD - Build, Test & Push Image

on:
  push:
    branches: [ "main", "test" ]
    paths:
      - 'BACKEND/LabNet/src/**'
      - 'BACKEND/LabNet/docker/**'
      - '.github/workflows/cd-image.yml'

permissions:
  contents: read
  id-token: write
  security-events: write

jobs:
  build-and-push:
    name: Build & Push to ECR
    runs-on: ubuntu-latest
    environment: AWS_ACCOUNT_ID

    env:
      AWS_REGION: us-east-1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
      ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
      ECR_REPOSITORY: espectaculos-web
      DOCKER_BUILDKIT: 1

    outputs:
      image-tag: ${{ steps.image.outputs.tag }}
      image-uri: ${{ steps.image.outputs.uri }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image metadata
        id: image
        run: |
          TAG="${GITHUB_SHA::8}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "uri=${ECR_REGISTRY}/${ECR_REPOSITORY}:${TAG}" >> $GITHUB_OUTPUT
          echo "uri-latest=${ECR_REGISTRY}/${ECR_REPOSITORY}:latest" >> $GITHUB_OUTPUT
        shell: bash

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Configure AWS credentials (access keys session)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        id: login-ecr

      - name: Check if ECR repository exists
        id: ecr-check
        run: |
          aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository --repository-name ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} --image-tag-mutability MUTABLE || true

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: BACKEND/LabNet
          file: BACKEND/LabNet/docker/Dockerfile.web
          push: true
          tags: |
            ${{ steps.image.outputs.uri }}
            ${{ steps.image.outputs.uri-latest }}
          build-args: |
            BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.image.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.image.outputs.uri }}
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          severity: 'CRITICAL'


      - name: Upload Trivy scan results
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-image-results.sarif'
          category: 'docker-image-scan'

      - name: Create deployment annotation
        run: |
          echo "✅ Docker image built and pushed successfully"
          echo "Image URI: ${{ steps.image.outputs.uri }}"
          echo "Image Tag: ${{ steps.image.outputs.tag }}"

  notify-deployment:
    name: Notify Deployment Ready
    runs-on: ubuntu-latest
    environment: AWS_ACCOUNT_ID
    needs: build-and-push
    if: success()

    steps:
      - name: Create deployment status
        run: |
          echo "✅ Image ready for deployment"
          echo "Image: ${{ needs.build-and-push.outputs.image-uri }}"
          echo "Tag: ${{ needs.build-and-push.outputs.image-tag }}"
