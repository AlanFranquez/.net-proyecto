name: CD - Deploy to Testing Environment

on:
  workflow_run:
    workflows: ["CD - Build, Test & Push Image"]
    types: [completed]
    branches: [main, test]

  workflow_dispatch:
    inputs:
      image-tag:
        description: "Image tag to deploy (default: latest)"
        required: false
        default: "latest"

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: espectaculos-api
  ECS_CLUSTER: espectaculos-testing
  ECS_SERVICE: espectaculos-api-service
  CONTAINER_NAME: espectaculos-api

jobs:
  deploy-testing:
    name: Deploy to Testing
    environment: AWS_ACCOUNT_ID   # <-- MUY IMPORTANTE
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (access keys + session token)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} |
          docker login \
            --username AWS \
            --password-stdin \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.image-tag }}"
          else
            TAG="latest"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Check image exists in ECR
        run: |
          aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag=${{ steps.tag.outputs.tag }} \
            --region ${{ env.AWS_REGION }}

      - name: Build new ECS task definition file
        id: build-taskdef
        run: |
          CURRENT=$(aws ecs describe-task-definition \
            --task-definition espectaculos-api-task \
            --query 'taskDefinition')

          IMAGE="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ steps.tag.outputs.tag }}"

          echo "$CURRENT" |
            jq --arg IMAGE "$IMAGE" \
              '.containerDefinitions[0].image = $IMAGE
               | del(.taskDefinitionArn)
               | del(.revision)
               | del(.status)
               | del(.requiresAttributes)' \
            > task-def.json

      - name: Register new task definition
        id: register
        run: |
          ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-def.json \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)

          echo "arn=$ARN" >> $GITHUB_OUTPUT

      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.register.outputs.arn }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait until service is stable
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }}

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy-testing

    steps:
      - name: Wait 30 seconds
        run: sleep 30

      - name: Call /health endpoint
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api-testing.example.com/health)
          echo "Status: $STATUS"
          test "$STATUS" = "200"

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: health-check

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "8.0.x"

      - name: Run smoke tests
        run: echo "Running smoke testsâ€¦"

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-testing, health-check, smoke-tests]
    if: always()

    steps:
      - name: Determine final status
        run: |
          if [ "${{ needs.deploy-testing.result }}" = "success" ] &&
             [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "Deployment OK"
          else
            echo "Deployment FAILED"
          fi
