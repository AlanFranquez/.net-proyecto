apiVersion: apps/v1
kind: Deployment
metadata:
  name: espectaculos-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: espectaculos
  template:
    metadata:
      labels:
        app: espectaculos
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: espectaculos
        image: 466060356317.dkr.ecr.us-east-1.amazonaws.com/espectaculos-web:latest
        ports:
        - containerPort: 8080
        env:
        - name: ASPNETCORE_URLS
          value: "http://+:8080"
        - name: CORS_ORIGINS
          value: "http://localhost:8080,http://mi-frontend-react-58b37209876tyg9.s3-website-us-east-1.amazonaws.com,http://localhost:5262"
        - name: Cors__AllowedOrigins
          value: "http://localhost:8080,http://mi-frontend-react-58b37209876tyg9.s3-website-us-east-1.amazonaws.com,http://localhost:5262"
        - name: ConnectionStrings__Default
          value: "Host=postgres-db.cb6u64euqqve.us-east-1.rds.amazonaws.com;Port=5432;Database=espectaculosdb;Username=postgres_user;Password=postgres_user"
        - name: DEFAULT_CONNECTION
          value: "Host=postgres-db.cb6u64euqqve.us-east-1.rds.amazonaws.com;Port=5432;Database=espectaculosdb;Username=postgres_user;Password=postgres_user"
        - name: REDIS_CONNECTION_STRING
          value: "redis-cluster.qatxfp.0001.use1.cache.amazonaws.com:6379"
        - name: AWS__Region
          value: "us-east-1"
        - name: AWS__Cognito__UserPoolId
          value: "us-east-1_TBr5rbzDq"
        - name: AWS__Cognito__ClientId
          value: "4s35v2gjsnc6l2rgc8bh9tsbuj"
        - name: AWS__Cognito__Region
          value: "us-east-1"
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-creds
              key: aws_access_key_id
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-creds
              key: aws_secret_access_key
        - name: AWS_SESSION_TOKEN
          valueFrom:
            secretKeyRef:
              name: aws-creds
              key: aws_session_token
        - name: REDIS__ENDPOINT
          value: "redis-cluster.qatxfp.0001.use1.cache.amazonaws.com"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otel-collector:4318"
        - name: OTEL_METRICS_EXPORTER
          value: "otlp"
        - name: OTEL_TRACES_EXPORTER
          value: "otlp"
        - name: OTEL_LOGS_EXPORTER
          value: "otlp"
        - name: OTEL_RESOURCE_ATTRIBUTES
          value: "service.name=espectaculos,service.namespace=production"
        - name: OTEL_EXPORTER_OTLP_METRICS_ENDPOINT
          value: "http://otel-collector:4318/v1/metrics"
        - name: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
          value: "http://otel-collector:4318/v1/traces"
        - name: OTEL_EXPORTER_OTLP_PROTOCOL
          value: "http/protobuf"
        - name: OTEL_EXPORTER_OTLP_METRICS_PROTOCOL
          value: "http/protobuf"

# SEQ
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: seq
spec:
  replicas: 1
  selector:
    matchLabels:
      app: seq
  template:
    metadata:
      labels:
        app: seq
    spec:
      securityContext:
        fsGroup: 1000
      containers:
        - name: seq
          image: datalust/seq:2024.3
          env:
            - name: ACCEPT_EULA
              value: "Y"
          ports:
            - containerPort: 80
          volumeMounts:
            - name: seq-storage
              mountPath: /data
      volumes:
        - name: seq-storage
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: seq
spec:
  type: LoadBalancer
  selector:
    app: seq
  ports:
    - port: 80
      targetPort: 80

# TEMPO
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: tempo-config
data:
  tempo.yaml: |
    server:
      http_listen_port: 3200

    distributor:
      receivers:
        otlp:
          protocols:
            http:
            grpc:

    storage:
      trace:
        backend: local
        local:
          path: /tmp/tempo/blocks
        wal:
          path: /tmp/tempo/wal
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tempo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tempo
  template:
    metadata:
      labels:
        app: tempo
    spec:
      containers:
        - name: tempo
          image: grafana/tempo:2.5.0
          args: ["-config.file=/etc/tempo/tempo.yaml"]
          volumeMounts:
            - mountPath: /etc/tempo
              name: tempo-config
      volumes:
        - name: tempo-config
          configMap:
            name: tempo-config
---
apiVersion: v1
kind: Service
metadata:
  name: tempo
spec:
  selector:
    app: tempo
  ports:
    - name: http
      port: 3200
      targetPort: 3200
    - name: otlp-grpc
      port: 4317
    - name: otlp-http
      port: 4318

# OTEL COLLECTOR
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-config
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          http:
          grpc:

    processors:
      batch: {}

    exporters:
      prometheus:
        endpoint: "0.0.0.0:9464"
      otlp:
        endpoint: "tempo:4317"
        tls:
          insecure: true

    service:
      pipelines:
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [prometheus]

        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [otlp]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-collector
spec:
  replicas: 1
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
    spec:
      containers:
        - name: otel-collector
          image: otel/opentelemetry-collector-contrib:0.102.1
          args: ["--config=/etc/otel/config.yaml"]
          volumeMounts:
            - name: otel-config
              mountPath: /etc/otel
          ports:
            - containerPort: 4317
            - containerPort: 4318
            - containerPort: 9464
      volumes:
        - name: otel-config
          configMap:
            name: otel-config
---
apiVersion: v1
kind: Service
metadata:
  name: otel-collector
spec:
  selector:
    app: otel-collector
  ports:
    - name: otlp-grpc
      port: 4317
    - name: otlp-http
      port: 4318
    - name: metrics
      port: 9464

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-provisioning
  namespace: default
data:
  dashboards.yml: |
    apiVersion: 1
    providers:
      - name: espectaculos-dashboards
        orgId: 1
        folder: Observability
        type: file
        options:
          path: /var/lib/grafana/dashboards
          foldersFromFilesStructure: true

  datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        uid: prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: true

      - name: Tempo
        uid: tempo
        type: tempo
        access: proxy
        url: http://tempo:3200
        editable: true
        jsonData:
          httpMethod: GET
          tracesToMetrics:
            datasourceUid: prometheus
          serviceMap:
            datasourceUid: prometheus
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: default
data:
  espectaculos-observability.json: |
    {
      "id": null,
      "title": "EspectÃ¡culos - Dashboard TÃ©cnico (3.5 Observabilidad)",
      "description": "Dashboard tÃ©cnico con indicadores de latencia, errores, sincronizaciones pendientes y trazabilidad con CorrelationId",
      "timezone": "browser",
      "schemaVersion": 39,
      "version": 3,
      "refresh": "10s",
      "tags": ["espectaculos", "otel", "prometheus", "observabilidad", "tecnico"],
      "panels": [
        { 
          "type": "row", 
          "title": "ðŸ“Š INDICADORES CLAVE (SLOs)", 
          "collapsed": false,
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0} 
        },
        {
          "type": "stat",
          "title": "ðŸŽ¯ P95 Latencia (SLO: < 300ms)",
          "description": "Percentil 95 de latencia - El 95% de las solicitudes se completan en este tiempo o menos",
          "gridPos": {"h": 4, "w": 6, "x": 0, "y": 1},
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum by (le) (rate(http_server_request_duration_seconds_bucket[5m])))",
              "legendFormat": "P95"
            }
          ],
          "options": {
            "graphMode": "area",
            "colorMode": "value",
            "justifyMode": "auto",
            "textMode": "value_and_name",
            "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}
          },
          "fieldConfig": {
            "defaults": {
              "unit": "ms",
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 300},
                  {"color": "red", "value": 500}
                ]
              }
            },
            "overrides": []
          }
        },
        {
          "type": "stat",
          "title": "ðŸŽ¯ P99 Latencia (SLO: < 500ms)",
          "description": "Percentil 99 de latencia - El 99% de las solicitudes se completan en este tiempo o menos",
          "gridPos": {"h": 4, "w": 6, "x": 6, "y": 1},
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.99, sum by (le) (rate(http_server_request_duration_seconds_bucket[5m]))) * 1000",
              "legendFormat": "P99"
            }
          ],
          "options": {
            "graphMode": "area",
            "colorMode": "value",
            "justifyMode": "auto",
            "textMode": "value_and_name",
            "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}
          },
          "fieldConfig": {
            "defaults": {
              "unit": "ms",
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 500},
                  {"color": "red", "value": 1000}
                ]
              }
            },
            "overrides": []
          }
        },
        {
          "type": "stat",
          "title": "âš¡ Tiempo Medio de Respuesta",
          "description": "Tiempo promedio de respuesta de todas las solicitudes HTTP",
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 1},
          "targets": [
            {
              "refId": "A",
              "expr": "(sum(rate(http_server_request_duration_seconds_sum[5m])) / sum(rate(http_server_request_duration_seconds_count[5m]))) * 1000",
              "legendFormat": "Promedio"
            }
          ],
          "options": {
            "graphMode": "area",
            "colorMode": "value",
            "justifyMode": "auto",
            "textMode": "value_and_name",
            "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}
          },
          "fieldConfig": {
            "defaults": {
              "unit": "ms",
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 200},
                  {"color": "red", "value": 400}
                ]
              }
            },
            "overrides": []
          }
        },
        {
          "type": "stat",
          "title": "âŒ Tasa de Errores (SLO: < 1%)",
          "description": "Porcentaje de solicitudes con errores (5xx)",
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 1},
          "targets": [
            {
              "refId": "A",
              "expr": "100 * (sum(rate(http_server_request_duration_seconds_count{http_response_status_code=~\"5..\"}[5m])) / sum(rate(http_server_request_duration_seconds_count[5m])))",
              "legendFormat": "Tasa Error %"
            }
          ],
          "options": {
            "graphMode": "area",
            "colorMode": "value",
            "justifyMode": "auto",
            "textMode": "value_and_name",
            "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}
          },
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 0,
              "max": 100,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 0.5},
                  {"color": "red", "value": 1}
                ]
              }
            },
            "overrides": []
          }
        },

        { 
          "type": "row", 
          "title": "ðŸ“ˆ LATENCIA DETALLADA", 
          "collapsed": false,
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 5} 
        },
        {
          "type": "timeseries",
          "title": "Latencia: P50, P95, P99 (Ãºltimos 5 minutos)",
          "description": "Percentiles de latencia a lo largo del tiempo",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 6},
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.50, sum by (le) (rate(http_server_request_duration_seconds_bucket[5m]))) * 1000",
              "legendFormat": "P50 (mediana)"
            },
            {
              "refId": "B",
              "expr": "histogram_quantile(0.95, sum by (le) (rate(http_server_request_duration_seconds_bucket[5m]))) * 1000",
              "legendFormat": "P95 (SLO: < 300ms)"
            },
            {
              "refId": "C",
              "expr": "histogram_quantile(0.99, sum by (le) (rate(http_server_request_duration_seconds_bucket[5m]))) * 1000",
              "legendFormat": "P99 (SLO: < 500ms)"
            }
          ],
          "options": {
            "legend": {"displayMode": "list", "placement": "bottom", "calcs": ["mean", "lastNotNull"]}, 
            "tooltip": {"mode": "multi"}
          },
          "fieldConfig": {
            "defaults": {
              "unit": "ms",
              "min": 0,
              "custom": {
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "fillOpacity": 10,
                "showPoints": "never"
              }
            },
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "P95 (SLO: < 300ms)"},
                "properties": [{"id": "color", "value": {"fixedColor": "yellow", "mode": "fixed"}}]
              },
              {
                "matcher": {"id": "byName", "options": "P99 (SLO: < 500ms)"},
                "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]
              }
            ]
          }
        },
        {
          "type": "timeseries",
          "title": "Latencia por Endpoint (P95)",
          "description": "P95 de latencia desglosado por ruta HTTP",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 14},
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum by (le, http_route) (rate(http_server_request_duration_seconds_bucket[5m]))) * 1000",
              "legendFormat": "{{http_route}}"
            }
          ],
          "options": {
            "legend": {"displayMode": "table", "placement": "right", "calcs": ["mean", "max", "lastNotNull"]}, 
            "tooltip": {"mode": "multi"}
          },
          "fieldConfig": {
            "defaults": {
              "unit": "ms",
              "min": 0,
              "custom": {
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "lineWidth": 1,
                "fillOpacity": 5
              }
            },
            "overrides": []
          }
        },

        { "type": "row", "title": "TrÃ¡fico", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 9} },
        {
          "type": "timeseries",
          "title": "RPS total",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 10},
          "targets": [
            { "refId": "A", "expr": "sum(rate(http_server_request_duration_seconds_count[1m]))", "legendFormat": "rps" }
          ],
          "fieldConfig": {"defaults": {"unit": "req/s", "min": 0}, "overrides": []}
        },
        {
          "type": "timeseries",
          "title": "RPS por cÃ³digo",
          "gridPos": {"h": 7, "w": 12, "x": 12, "y": 10},
          "targets": [
            { "refId": "A", "expr": "sum by (http_response_status_code) (rate(http_server_request_duration_seconds_count[1m]))", "legendFormat": "{{http_response_status_code}}" }
          ],
          "fieldConfig": {"defaults": {"unit": "req/s", "min": 0}, "overrides": []}
        },

        { "type": "row", "title": "Errores", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 17} },
        {
          "type": "timeseries",
          "title": "Error rate 5xx (%)",
          "gridPos": {"h": 7, "w": 24, "x": 0, "y": 18},
          "targets": [
            { "refId": "A", "expr": "100 * sum(rate(http_server_request_duration_seconds_count{http_response_status_code=~\"5..\"}[5m])) / sum(rate(http_server_request_duration_seconds_count[5m]))", "legendFormat": "5xx %" }
          ],
          "fieldConfig": {"defaults": {"unit": "percentunit", "min": 0, "max": 100}, "overrides": []}
        },

        { "type": "row", "title": "Concurrencia", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 25} },
        {
          "type": "gauge",
          "title": "Requests concurrentes",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 26},
          "targets": [ { "refId": "A", "expr": "sum(http_server_active_requests)" } ],
          "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "showThresholdLabels": false, "showThresholdMarkers": true},
          "fieldConfig": {"defaults": {"unit": "none", "min": 0}, "overrides": []}
        },

        { "type": "row", "title": "Sincronizaciones", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 33} },
        {
          "type": "gauge",
          "title": "Backlog de sincronizaciones pendientes",
          "gridPos": {"h": 7, "w": 12, "x": 0, "y": 34},
          "targets": [ { "refId": "A", "expr": "app_sincronizaciones_backlog" } ],
          "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "showThresholdLabels": false, "showThresholdMarkers": true},
          "fieldConfig": {
            "defaults": {
              "unit": "none",
              "min": 0,
              "thresholds": {"mode": "absolute", "steps": [ {"color": "green", "value": null}, {"color": "yellow", "value": 10}, {"color": "red", "value": 50} ]} 
            },
            "overrides": []
          }
        }
      ]
    }

---
# Prometheus rules
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: default
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      # Scrapear mÃ©tricas del OTEL Collector
      - job_name: 'otel-collector'
        static_configs:
          - targets: ['otel-collector:9464']
      
      # Scrapear mÃ©tricas directamente de los pods de la aplicaciÃ³n
      - job_name: 'espectaculos-app'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            target_label: __address__
            regex: (.+);(.+)
            replacement: $1:$2
          - source_labels: [__meta_kubernetes_namespace]
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: kubernetes_pod_name
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
      
      # Scrapear mÃ©tricas de los nodos de Kubernetes
      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)

    rule_files:
      - /etc/prometheus/rules/*.yml
---
# Grafana Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      securityContext:
        fsGroup: 472
      containers:
        - name: grafana
          image: grafana/grafana:11.2.0
          env:
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: "admin"
          ports:
            - containerPort: 3000
          volumeMounts:
            - name: grafana-provisioning
              mountPath: /etc/grafana/provisioning
            - name: grafana-dashboards
              mountPath: /var/lib/grafana/dashboards
      volumes:
        - name: grafana-provisioning
          configMap:
            name: grafana-provisioning
            items:
              - key: dashboards.yml
                path: dashboards/dashboards.yml
              - key: datasources.yml
                path: datasources/datasources.yml
        - name: grafana-dashboards
          configMap:
            name: grafana-dashboards
            items:
              - key: espectaculos-observability.json
                path: espectaculos-observability.json

---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: default
spec:
  type: LoadBalancer
  selector:
    app: grafana
  ports:
    - port: 3000
      targetPort: 3000

---
# Prometheus Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
        - name: prometheus
          image: prom/prometheus:v2.54.1
          args:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
          ports:
            - containerPort: 9090
          volumeMounts:
            - name: prometheus-config
              mountPath: /etc/prometheus/prometheus.yml
              subPath: prometheus.yml
      volumes:
        - name: prometheus-config
          configMap:
            name: prometheus-config

---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: default
spec:
  type: ClusterIP
  selector:
    app: prometheus
  ports:
    - port: 9090
      targetPort: 9090
---
# Rabbit MQ
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rabbitmq
  labels:
    app: rabbitmq
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      containers:
        - name: rabbitmq
          image: rabbitmq:management
          ports:
            - containerPort: 5672   # AMQP
            - containerPort: 15672  # Management UI
          env:
            - name: RABBITMQ_DEFAULT_USER
              value: admin
            - name: RABBITMQ_DEFAULT_PASS
              value: admin
---
apiVersion: v1
kind: Service
metadata:
  name: rabbitmq
spec:
  selector:
    app: rabbitmq
  ports:
    - name: amqp
      port: 5672
      targetPort: 5672
    - name: management
      port: 15672
      targetPort: 15672
  type: ClusterIP
